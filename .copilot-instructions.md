# Copilot Instructions - Playground Shared Services

## Repository Overview

This repository contains a **Docker Compose-based shared services platform** designed to run on a **NAS alongside other containerized applications**. It provides enterprise-grade infrastructure services for distributed systems including authentication, messaging, secrets management, observability, and PKI/certificate management.

**Primary Deployment Target:** Network Attached Storage (NAS) with Docker Engine, coexisting with other services

**Development Environment:** Local development on Windows, Linux, or macOS

## Core Components

The platform consists of the following dockerized services:

### Authentication & Authorization
- **Keycloak** (Port 8082/8080) - OpenID Connect, OAuth2, SAML identity provider with PostgreSQL backend
- **PostgreSQL** - Persistent database for Keycloak

### Messaging
- **RabbitMQ** (5672 AMQP, 15672 Management UI) - Message broker with management console

### Secrets & PKI
- **Vault** (Port 8201) - HashiCorp Vault for secret management and PKI certificate authority
  - Root CA and Intermediate CA support
  - Server and client certificate generation
  - API key and credential storage

### Observability & Monitoring
- **Prometheus** (Port 9090) - Metrics collection and time-series database
- **Loki** (Port 3100) - Log aggregation system with LogQL querying
- **Tempo** (Port 3200) - Distributed tracing with OpenTelemetry support (gRPC: 4317, HTTP: 4318)
- **Grafana** (Port 3000) - Unified observability dashboard with pre-configured datasources

## Architecture Patterns

This is a containerized, networked microservices platform where:
- All services communicate via Docker bridge network (`shared-services`)
- Services use health checks for orchestration
- Configuration is environment-driven (`.env` file)
- Certificates and PKI are managed via Vault PKI engine
- HTTPS/TLS is enforced for inter-service communication
- Client applications (ASP.NET Core, containers, etc.) integrate as external consumers

## Configuration Management

Key configuration areas:
- **`.env` file**: Passwords, tokens, hostnames, domain names, IP SANs for certificates
- **`config/` directory**: YAML configurations for Prometheus, Grafana, Loki, Tempo, Traefik, Vault
- **`config/vault/vault-config.hcl`**: Vault backend and PKI configuration
- **`config/grafana/provisioning/`**: Grafana datasources and dashboard definitions
- **`scripts/`**: PowerShell and Bash scripts for certificate generation and validation

## Certificate Management

The platform uses **Vault PKI Engine** for:
- Generating self-signed Root CA certificates
- Creating Intermediate CAs for certificate issuance
- Issuing server certificates for HTTPS/TLS
- Issuing client certificates for mTLS between services
- Certificate rotation and renewal

**Relevant scripts:**
- `scripts/generate-certs-vault.ps1` - Generate certificates with IP SANs and domain names
- `scripts/setup-vault-https.ps1` - Configure Vault with HTTPS
- `scripts/rotate-certs.sh` - Rotate existing certificates
- `scripts/validate-vault-cert.ps1` - Validate certificate chains

## NAS Deployment Considerations

When providing guidance, keep in mind:
- The platform is designed to coexist with other containerized services on a NAS
- Network configuration must support service discovery and inter-service communication
- Storage volumes are persistent (e.g., `keycloak-db-data`, `vault-data`)
- Hostname configuration in `.env` determines certificate CNs and FQDN resolution
- Health checks ensure service availability in shared infrastructure
- The `HOST_NAME` environment variable should match the NAS hostname for certificate generation
- Resource constraints may apply on shared NAS systems (memory, CPU)

### Docker Access Restrictions
- **Docker commands cannot be executed locally** from development machines
- **All Docker management is through the NAS web UI only** via secured SSL/HTTPS connections
- Changes to services, configurations, and deployments must be made through the NAS web interface
- This means development workflow focuses on configuration files and scripts rather than direct container manipulation
- Updates to `docker-compose.yml` and configuration files still happen locally, but deployment happens via NAS UI

## Common Development Tasks

### Service Management
**Note:** All Docker commands must be executed through the **NAS web UI** via SSL connection. Local docker command execution is not available.

Service status, Log viewing, container management, and deployment changes are handled via the NAS management interface.

### Configuration Updates
Local development focuses on:
- Modifying `docker-compose.yml` and configuration files
- Preparing `.env` environment variable updates
- These changes are then deployed through the NAS web UI

### Certificate Operations
```powershell
# Generate certificates for a domain/IP
.\scripts\generate-certs-vault.ps1 -Domain "rabbit.local" -IpSans "192.168.178.35" -VaultAddr "http://vault.local:8201"

# Validate certificate chain
.\scripts\validate-vault-cert.ps1 -CertPath "certs/rabbit.local.crt" -RootCAPath "certs/root-ca.crt"
```

### Service Access
- **Grafana**: http://HOST_NAME:3000 (Dashboards, metrics queries)
- **Keycloak**: http://HOST_NAME:8082 (Identity configuration)
- **Vault**: http://HOST_NAME:8201 (Secret management)
- **RabbitMQ**: https://rabbit.local:8443 (Message queue management)
- **Prometheus**: http://HOST_NAME:9090 (Raw metrics)

## Code Guidelines

When modifying this repository:
- **Docker Compose**: Keep services isolated with proper networking and health checks
- **Environment Variables**: Use `.env` for configuration, never hardcode secrets
- **Certificates**: Always use Vault PKI Engine for certificate generation, scripts in `scripts/`
- **Configuration Files**: YAML files in `config/` should be validated before deployment
- **Documentation**: Maintain markdown documentation for setup procedures and architectural changes
- **Cross-platform**: Scripts should support both PowerShell (Windows) and Bash (Linux/macOS)

## Integration Points

External applications integrate with this platform via:
- **Keycloak OpenID Connect endpoints** for authentication/authorization
- **RabbitMQ AMQP protocol** for asynchronous messaging
- **Vault HTTP API** for secrets and certificate retrieval
- **Prometheus scrape endpoints** for metrics exposure
- **OTLP gRPC/HTTP** to Tempo for distributed tracing
- **Loki push API** for log aggregation

## Important Files

- [docker-compose.yml](docker-compose.yml) - Service definitions
- [ARCHITECTURE.md](ARCHITECTURE.md) - Detailed platform architecture
- [README.md](README.md) - Setup and usage guide
- [KEYCLOAK_SETUP.md](KEYCLOAK_SETUP.md) - Keycloak configuration
- [PKI_SETUP_VAULT.md](PKI_SETUP_VAULT.md) - PKI engine setup
- [config/vault/vault-config.hcl](config/vault/vault-config.hcl) - Vault configuration
- [scripts/README_VAULT_PKI.md](scripts/README_VAULT_PKI.md) - Certificate generation guide
